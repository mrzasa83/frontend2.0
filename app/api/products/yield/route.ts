import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { queryMSSQL } from '@/lib/db/mssql'

export async function POST(request: NextRequest) {
  const session = await getServerSession(authOptions)
  
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const { apcPN } = await request.json()

    if (!apcPN) {
      return NextResponse.json(
        { error: 'apcPN is required' },
        { status: 400 }
      )
    }

    // Query Paradigm MS SQL database for yield data
    const query = `
      SELECT
        DATA0050_1.CUSTOMER_PART_NUMBER,
        DATA0017_1.INV_PART_NUMBER AS INV_PART_NUMBER,
        DATA0006_1.WORK_ORDER_NUMBER,
        DATA0006_1.QUAN_SCH,
        DATA0006_1.QUAN_PROD,
        DATA0006_1.QUAN_REJ,
        REPLACE(CASE
          WHEN DATA0006_1.WORK_ORDER_NUMBER NOT LIKE '%-000' THEN (SELECT DATA0045.PROD_SPEC_04 FROM DATA0045 DATA0045
            WHERE DATA0045.SOURCE_PTR = DATA0017_1.RKEY AND DATA0006_1.INVENTORY_PTR = DATA0017_1.RKEY AND DATA0045.SOURCE_TYPE ='1')
          WHEN DATA0006_1.WORK_ORDER_NUMBER LIKE '%-000' THEN (SELECT DATA0045.PROD_SPEC_04 FROM DATA0045 WHERE DATA0045.SOURCE_PTR = DATA0050_1.RKEY AND DATA0045.SOURCE_TYPE ='2')
        END, ',', ' ') AS BASE_SPEC,
        REPLACE(CASE
          WHEN DATA0006_1.WORK_ORDER_NUMBER NOT LIKE '%-000' THEN (SELECT DATA0045.PROD_SPEC_05 FROM DATA0045 DATA0045 
            WHERE DATA0045.SOURCE_PTR = DATA0017_1.RKEY AND DATA0006_1.INVENTORY_PTR = DATA0017_1.RKEY AND DATA0045.SOURCE_TYPE ='1')
          WHEN DATA0006_1.WORK_ORDER_NUMBER LIKE '%-000' THEN (SELECT DATA0045.PROD_SPEC_05 FROM DATA0045 WHERE DATA0045.SOURCE_PTR = DATA0050_1.RKEY AND DATA0045.SOURCE_TYPE ='2')
        END, ',', ' ') AS END_CUST_SPEC,
        CASE
          WHEN DATA0006_1.WORK_ORDER_NUMBER NOT LIKE '%-000' THEN (SELECT DATA0045.PROD_SPEC_01 FROM DATA0045 DATA0045 
            WHERE DATA0045.SOURCE_PTR = DATA0017_1.RKEY AND DATA0006_1.INVENTORY_PTR = DATA0017_1.RKEY AND DATA0045.SOURCE_TYPE ='1')
          WHEN DATA0006_1.WORK_ORDER_NUMBER LIKE '%-000' THEN (SELECT DATA0045.PROD_SPEC_01 FROM DATA0045 WHERE DATA0045.SOURCE_PTR = DATA0050_1.RKEY AND DATA0045.SOURCE_TYPE ='2')
        END AS MATERIAL,
        CASE
          WHEN DATA0006_1.WORK_ORDER_NUMBER NOT LIKE '%-000' THEN (SELECT DATA0044.PROD_PARA_08 FROM DATA0044 DATA0044 
            WHERE DATA0044.SOURCE_PTR = DATA0017_1.RKEY AND DATA0006_1.INVENTORY_PTR = DATA0017_1.RKEY AND DATA0044.SOURCE_TYPE ='1')
          WHEN DATA0006_1.WORK_ORDER_NUMBER LIKE '%-000' THEN (SELECT DATA0044.PROD_PARA_08 FROM DATA0044 WHERE DATA0044.SOURCE_PTR = DATA0050_1.RKEY AND DATA0044.SOURCE_TYPE ='2')
        END AS PANEL_SIZE,
        100-DATA0006_1.SCRAP_RATE AS PLAN_YLD,
        ((DATA0006_1.QUAN_SCH - DATA0006_1.QUAN_REJ)/NULLIF(DATA0006_1.QUAN_SCH, 0) * 100) AS ACT_YIELD,
        DATA0006_1.RELEASE_DATE AS START_DATE,
        DATA0006_1.ACT_COMPL_DATE
      FROM
        DATA0006 DATA0006_1
        LEFT OUTER JOIN DATA0050 DATA0050_1 ON DATA0050_1.RKEY = DATA0006_1.CUST_PART_PTR
        LEFT OUTER JOIN DATA0010 DATA0010_1 ON DATA0010_1.RKEY = DATA0050_1.CUSTOMER_PTR
        LEFT OUTER JOIN DATA0015 DATA0015_1 ON DATA0015_1.RKEY = DATA0006_1.WHOUSE_PTR
        LEFT OUTER JOIN DATA0025 DATA0025_1 ON DATA0006_1.BOM_PTR = DATA0025_1.RKEY
        LEFT OUTER JOIN DATA0017 DATA0017_1 ON DATA0025_1.INVENTORY_PTR = DATA0017_1.RKEY
        LEFT OUTER JOIN DATA0008 DATA0008_1 ON DATA0050_1.PROD_CODE_PTR = DATA0008_1.RKEY
        LEFT OUTER JOIN DATA0008 DATA0008_2 ON DATA0008_2.RKEY = DATA0017_1.PROD_CODE_SELL_PTR
        LEFT OUTER JOIN VW_PRODUCT_CODE VW_PRODUCT_CODE_1 ON VW_PRODUCT_CODE_1.D008_RKEY = DATA0008_1.RKEY
      WHERE
        DATA0050_1.CUSTOMER_PART_NUMBER LIKE @partNumber
      ORDER BY
        DATA0006_1.WORK_ORDER_NUMBER DESC
    `

    const results = await queryMSSQL('1', query, {
      partNumber: `${apcPN}%`
    })

    return NextResponse.json({
      success: true,
      apcPN,
      count: results.length,
      data: results
    })
  } catch (error) {
    console.error('Error fetching yield data:', error)
    return NextResponse.json(
      { 
        error: 'Failed to fetch yield data', 
        details: error instanceof Error ? error.message : String(error) 
      },
      { status: 500 }
    )
  }
}
