{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///users/mrzasa/projects/current/frontend2.4/lib/auth.ts"],"sourcesContent":["import { NextAuthOptions } from 'next-auth'\r\nimport CredentialsProvider from 'next-auth/providers/credentials'\r\nimport bcrypt from 'bcryptjs'\r\nimport { queryPrimary } from './db/mysql-primary'\r\n\r\ninterface User {\r\n  id: number\r\n  username: string\r\n  name: string | null\r\n  email: string | null\r\n  password: string\r\n  active: number | null\r\n}\r\n\r\ninterface Role {\r\n  id: number\r\n  name: string\r\n}\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: 'Credentials',\r\n      credentials: {\r\n        username: { label: 'Username', type: 'text' },\r\n        password: { label: 'Password', type: 'password' }\r\n      },\r\n      async authorize(credentials) {\r\n        if (!credentials?.username || !credentials?.password) {\r\n          return null\r\n        }\r\n\r\n        try {\r\n          // Get user\r\n          const users = await queryPrimary<User[]>(\r\n            'SELECT * FROM Users WHERE username = ? AND active = 1',\r\n            [credentials.username]\r\n          )\r\n\r\n          const user = users[0]\r\n\r\n          if (!user || !user.password) {\r\n            return null\r\n          }\r\n\r\n          // Verify password\r\n          const isValid = await bcrypt.compare(credentials.password, user.password)\r\n\r\n          if (!isValid) {\r\n            return null\r\n          }\r\n\r\n          // Get user roles\r\n          const roles = await queryPrimary<Role[]>(\r\n            `SELECT r.id, r.name \r\n             FROM roles r\r\n             INNER JOIN user_roles ur ON r.id = ur.roleId\r\n             WHERE ur.userId = ?`,\r\n            [user.id]\r\n          )\r\n\r\n          const roleNames = roles.map(r => r.name)\r\n\r\n          return {\r\n            id: user.id.toString(),\r\n            name: user.name || user.username,\r\n            email: user.email || '',\r\n            username: user.username,\r\n            roles: roleNames\r\n          }\r\n        } catch (error) {\r\n          console.error('Auth error:', error)\r\n          return null\r\n        }\r\n      }\r\n    })\r\n  ],\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.id = user.id\r\n        token.username = user.username\r\n        token.roles = user.roles\r\n      }\r\n      return token\r\n    },\r\n    async session({ session, token }) {\r\n      if (session.user) {\r\n        session.user.id = token.id as string\r\n        session.user.username = token.username as string\r\n        session.user.roles = token.roles as string[]\r\n        \r\n        // Create initials from name\r\n        const nameParts = session.user.name?.split(' ') || ['U']\r\n        session.user.initials = nameParts.length > 1 \r\n          ? `${nameParts[0][0]}${nameParts[1][0]}`.toUpperCase()\r\n          : nameParts[0].substring(0, 2).toUpperCase()\r\n      }\r\n      return session\r\n    }\r\n  },\r\n  pages: {\r\n    signIn: '/login',\r\n  },\r\n  session: {\r\n    strategy: 'jwt',\r\n    maxAge: 30 * 24 * 60 * 60, // 30 days\r\n  },\r\n  secret: process.env.NEXTAUTH_SECRET,\r\n}"],"names":[],"mappings":";;;;AACA;AACA;AACA;;;;AAgBO,MAAM,cAA+B;IAC1C,WAAW;QACT,IAAA,uLAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAO;gBAC5C,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,YAAY,CAAC,aAAa,UAAU;oBACpD,OAAO;gBACT;gBAEA,IAAI;oBACF,WAAW;oBACX,MAAM,QAAQ,MAAM,IAAA,iKAAY,EAC9B,yDACA;wBAAC,YAAY,QAAQ;qBAAC;oBAGxB,MAAM,OAAO,KAAK,CAAC,EAAE;oBAErB,IAAI,CAAC,QAAQ,CAAC,KAAK,QAAQ,EAAE;wBAC3B,OAAO;oBACT;oBAEA,kBAAkB;oBAClB,MAAM,UAAU,MAAM,gKAAM,CAAC,OAAO,CAAC,YAAY,QAAQ,EAAE,KAAK,QAAQ;oBAExE,IAAI,CAAC,SAAS;wBACZ,OAAO;oBACT;oBAEA,iBAAiB;oBACjB,MAAM,QAAQ,MAAM,IAAA,iKAAY,EAC9B,CAAC;;;gCAGmB,CAAC,EACrB;wBAAC,KAAK,EAAE;qBAAC;oBAGX,MAAM,YAAY,MAAM,GAAG,CAAC,CAAA,IAAK,EAAE,IAAI;oBAEvC,OAAO;wBACL,IAAI,KAAK,EAAE,CAAC,QAAQ;wBACpB,MAAM,KAAK,IAAI,IAAI,KAAK,QAAQ;wBAChC,OAAO,KAAK,KAAK,IAAI;wBACrB,UAAU,KAAK,QAAQ;wBACvB,OAAO;oBACT;gBACF,EAAE,OAAO,OAAO;oBACd,QAAQ,KAAK,CAAC,eAAe;oBAC7B,OAAO;gBACT;YACF;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;gBAClB,MAAM,QAAQ,GAAG,KAAK,QAAQ;gBAC9B,MAAM,KAAK,GAAG,KAAK,KAAK;YAC1B;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;gBAC1B,QAAQ,IAAI,CAAC,QAAQ,GAAG,MAAM,QAAQ;gBACtC,QAAQ,IAAI,CAAC,KAAK,GAAG,MAAM,KAAK;gBAEhC,4BAA4B;gBAC5B,MAAM,YAAY,QAAQ,IAAI,CAAC,IAAI,EAAE,MAAM,QAAQ;oBAAC;iBAAI;gBACxD,QAAQ,IAAI,CAAC,QAAQ,GAAG,UAAU,MAAM,GAAG,IACvC,GAAG,SAAS,CAAC,EAAE,CAAC,EAAE,GAAG,SAAS,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,WAAW,KAClD,SAAS,CAAC,EAAE,CAAC,SAAS,CAAC,GAAG,GAAG,WAAW;YAC9C;YACA,OAAO;QACT;IACF;IACA,OAAO;QACL,QAAQ;IACV;IACA,SAAS;QACP,UAAU;QACV,QAAQ,KAAK,KAAK,KAAK;IACzB;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC","debugId":null}},
    {"offset": {"line": 248, "column": 0}, "map": {"version":3,"sources":["file:///users/mrzasa/projects/current/frontend2.4/app/api/users/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { getServerSession } from 'next-auth'\r\nimport { authOptions } from '@/lib/auth'\r\nimport { queryPrimary } from '@/lib/db/mysql-primary'\r\nimport bcrypt from 'bcryptjs'\r\n\r\n// GET - Fetch all users\r\nexport async function GET() {\r\n  const session = await getServerSession(authOptions)\r\n  \r\n  if (!session) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n  }\r\n\r\n  try {\r\n    const users = await queryPrimary<any[]>(\r\n      `SELECT \r\n        id,\r\n        username,\r\n        name,\r\n        email,\r\n        nickname,\r\n        phone,\r\n        mobile,\r\n        title,\r\n        role,\r\n        active,\r\n        createdAt\r\n      FROM Users \r\n      WHERE active = 1\r\n      ORDER BY name ASC`\r\n    )\r\n\r\n    return NextResponse.json(users)\r\n  } catch (error) {\r\n    console.error('Error fetching users:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to fetch users' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// POST - Create new user\r\nexport async function POST(request: NextRequest) {\r\n  const session = await getServerSession(authOptions)\r\n  \r\n  if (!session) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n  }\r\n\r\n  // TODO: Check if user has admin role\r\n\r\n  try {\r\n    const data = await request.json()\r\n\r\n    // Validate required fields\r\n    if (!data.username || !data.name || !data.email || !data.password) {\r\n      return NextResponse.json(\r\n        { error: 'Missing required fields' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Check if username already exists\r\n    const existingUser = await queryPrimary<any[]>(\r\n      'SELECT id FROM Users WHERE username = ?',\r\n      [data.username]\r\n    )\r\n\r\n    if (existingUser.length > 0) {\r\n      return NextResponse.json(\r\n        { error: 'Username already exists' },\r\n        { status: 409 }\r\n      )\r\n    }\r\n\r\n    // Check if email already exists\r\n    const existingEmail = await queryPrimary<any[]>(\r\n      'SELECT id FROM Users WHERE email = ?',\r\n      [data.email]\r\n    )\r\n\r\n    if (existingEmail.length > 0) {\r\n      return NextResponse.json(\r\n        { error: 'Email already exists' },\r\n        { status: 409 }\r\n      )\r\n    }\r\n\r\n    // Hash password\r\n    const hashedPassword = await bcrypt.hash(data.password, 10)\r\n\r\n    // Insert new user\r\n    const result = await queryPrimary(\r\n      `INSERT INTO Users (\r\n        username,\r\n        name,\r\n        email,\r\n        nickname,\r\n        phone,\r\n        mobile,\r\n        password,\r\n        title,\r\n        active,\r\n        role,\r\n        createdAt,\r\n        updatedAt\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`,\r\n      [\r\n        data.username,\r\n        data.name,\r\n        data.email,\r\n        data.nickname || null,\r\n        data.phone || null,\r\n        data.mobile || null,\r\n        hashedPassword,\r\n        data.title || null,\r\n        data.active !== undefined ? data.active : 1,\r\n        data.role || null\r\n      ]\r\n    )\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'User created successfully',\r\n      userId: (result as any).insertId\r\n    })\r\n  } catch (error) {\r\n    console.error('Error creating user:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to create user', details: String(error) },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAGO,eAAe;IACpB,MAAM,UAAU,MAAM,IAAA,6KAAgB,EAAC,8IAAW;IAElD,IAAI,CAAC,SAAS;QACZ,OAAO,kKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;IAEA,IAAI;QACF,MAAM,QAAQ,MAAM,IAAA,iKAAY,EAC9B,CAAC;;;;;;;;;;;;;;uBAcgB,CAAC;QAGpB,OAAO,kKAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,kKAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,KAAK,OAAoB;IAC7C,MAAM,UAAU,MAAM,IAAA,6KAAgB,EAAC,8IAAW;IAElD,IAAI,CAAC,SAAS;QACZ,OAAO,kKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;IAEA,qCAAqC;IAErC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAE/B,2BAA2B;QAC3B,IAAI,CAAC,KAAK,QAAQ,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,KAAK,QAAQ,EAAE;YACjE,OAAO,kKAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,mCAAmC;QACnC,MAAM,eAAe,MAAM,IAAA,iKAAY,EACrC,2CACA;YAAC,KAAK,QAAQ;SAAC;QAGjB,IAAI,aAAa,MAAM,GAAG,GAAG;YAC3B,OAAO,kKAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,gCAAgC;QAChC,MAAM,gBAAgB,MAAM,IAAA,iKAAY,EACtC,wCACA;YAAC,KAAK,KAAK;SAAC;QAGd,IAAI,cAAc,MAAM,GAAG,GAAG;YAC5B,OAAO,kKAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAuB,GAChC;gBAAE,QAAQ;YAAI;QAElB;QAEA,gBAAgB;QAChB,MAAM,iBAAiB,MAAM,gKAAM,CAAC,IAAI,CAAC,KAAK,QAAQ,EAAE;QAExD,kBAAkB;QAClB,MAAM,SAAS,MAAM,IAAA,iKAAY,EAC/B,CAAC;;;;;;;;;;;;;2DAaoD,CAAC,EACtD;YACE,KAAK,QAAQ;YACb,KAAK,IAAI;YACT,KAAK,KAAK;YACV,KAAK,QAAQ,IAAI;YACjB,KAAK,KAAK,IAAI;YACd,KAAK,MAAM,IAAI;YACf;YACA,KAAK,KAAK,IAAI;YACd,KAAK,MAAM,KAAK,YAAY,KAAK,MAAM,GAAG;YAC1C,KAAK,IAAI,IAAI;SACd;QAGH,OAAO,kKAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT,QAAQ,AAAC,OAAe,QAAQ;QAClC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,kKAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAyB,SAAS,OAAO;QAAO,GACzD;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}